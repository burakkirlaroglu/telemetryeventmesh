name: telemetryeventmesh

networks:
  public_net:
    name: tem_public_net
  internal_net:
    name: tem_internal_net
    internal: true
  data_net:
    name: tem_data_net
    internal: true

volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:


services:
  postgres:
    image: postgres:16-alpine
    container_name: tem_postgres
    env_file:
      - .env
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - data_net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-tem} -d ${POSTGRES_DB:-tem}" ]
      interval: 5s
      timeout: 3s
      retries: 20
    deploy:
      resources:
        limits:
          memory: 768M

  redis:
    image: redis:7-alpine
    container_name: tem_redis
    command: [ "redis-server", "--appendonly", "yes" ]
    volumes:
      - redis_data:/data
    networks:
      - data_net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 20
    deploy:
      resources:
        limits:
          memory: 256M

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: tem_rabbitmq
    env_file:
      - .env
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - data_net
    healthcheck:
      test: [ "CMD-SHELL", "rabbitmq-diagnostics -q ping" ]
      interval: 5s
      timeout: 3s
      retries: 20
    deploy:
      resources:
        limits:
          memory: 512M

  control_api_1:
    build:
      context: ../../services/control_api
    container_name: tem_control_api_1
    networks:
      - internal_net
    healthcheck:
      test: [ "CMD-SHELL", "echo hello" ]
      interval: 5s
      timeout: 3s
      retries: 20

  control_api_2:
    build:
      context: ../../services/control_api
    container_name: tem_control_api_2
    networks:
      - internal_net
    healthcheck:
      test: [ "CMD-SHELL", "echo hello" ]
      interval: 5s
      timeout: 3s
      retries: 20

  control_api_3:
    build:
      context: ../../services/control_api
    container_name: tem_control_api_3
    networks:
      - internal_net
    healthcheck:
      test: [ "CMD-SHELL", "echo hello" ]
      interval: 5s
      timeout: 3s
      retries: 20

  ws_gateway_1:
    build:
      context: ../../services/live_stream_gateway
    container_name: tem_ws_gateway_1
    environment:
      GATEWAY_ID: tem_ws_gateway_1
    env_file:
      - .env
    networks:
      - internal_net
      - data_net
    healthcheck:
      test: [ "CMD-SHELL", "python - <<EOF\nimport redis; redis.Redis(host='tem_redis', port=6379).ping()\nEOF" ]
      interval: 5s
      timeout: 3s
      retries: 5

  ws_gateway_2:
    build:
      context: ../../services/live_stream_gateway
    container_name: tem_ws_gateway_2
    environment:
      GATEWAY_ID: tem_ws_gateway_2
    env_file:
      - .env
    networks:
      - internal_net
      - data_net
    healthcheck:
      test: [ "CMD-SHELL", "python - <<EOF\nimport redis; redis.Redis(host='tem_redis', port=6379).ping()\nEOF" ]
      interval: 5s
      timeout: 3s
      retries: 5

  event_ingestor:
    build:
      context: ../../services/event_ingestor
    container_name: tem_event_ingestor
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - .env
    networks:
      - internal_net
      - data_net

  celery_beat:
    build:
      context: ../../services/event_ingestor
    command: celery -A config.celery_app beat --loglevel=info
    env_file:
      - .env
    depends_on:
      - rabbitmq
      - postgres
    networks:
      - internal_net
      - data_net

  celery_worker_processing:
    build: ../../services/event_ingestor
    command: celery -A config.celery_app worker -Q processing_queue --loglevel=info --concurrency=2
    env_file:
      - .env
    depends_on:
      - rabbitmq
      - postgres
    networks:
      - internal_net
      - data_net

  celery_worker_maintenance:
    build: ../../services/event_ingestor
    command: celery -A config.celery_app worker -Q maintenance_queue --loglevel=info --concurrency=1
    env_file:
      - .env
    depends_on:
      - rabbitmq
      - postgres
    networks:
      - internal_net
      - data_net

  nginx_gateway:
    image: nginx:1.25-alpine
    container_name: tem_nginx_gateway
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - public_net
      - internal_net
    ports:
      - "80:80"
    depends_on:
      control_api_1:
        condition: service_healthy
      control_api_2:
        condition: service_healthy
      control_api_3:
        condition: service_healthy
      ws_gateway_1:
        condition: service_healthy
      ws_gateway_2:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://127.0.0.1/healthz || exit 1" ]
      interval: 5s
      timeout: 3s
      retries: 20
