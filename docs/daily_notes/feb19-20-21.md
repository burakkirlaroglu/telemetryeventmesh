### 19-20-21 Şubat

### Event Lifecycle, Celery Reliability, WebSocket Integration, CI Stabilization

## 1. Event State Machine Stabilizasyonu

Bugün Event → ProcessingState akışı üzerinde derinlemesine çalışıldı.

Amaç sadece “çalışıyor mu?” değil,
“Crash durumunda veri tutarlılığı korunuyor mu?” sorusuna cevap bulmaktı.

### Yapılanlar:

* `transaction.on_commit` ile task dispatch mekanizması korunarak üretim davranışı taklit edildi.
* Test ortamında on_commit’in transactional test runner nedeniyle çalışmaması problemi keşfedildi.
* State machine test ederken infrastructure lifecycle test edilmediği netleştirildi.
* Test ortamında task dispatch deterministic hale getirildi.
* Celery eager mod aktif edilerek state machine senkron test edilebilir hale getirildi.

Önemli fark:

Production akışı:
Request → Commit → Task → Yeni DB transaction

Test akışı:
Request → Aynı transaction içinde task (eager)

---

## 2. Redis Bağımlılığı ve Gerçek Integration Test

Task içinde Redis publish olduğu için:

* Redis olmadan state FAILED’a düşüyordu.
* Bu, test ortamında bağımlılığın eksik olduğunu gösterdi.
* Redis compose’a eklendi.
* `depends_on` ile servis bağımlılığı netleştirildi.

Mock kullanmak yerine gerçek Redis ile integration test tercih edildi.

Sonuç:

* State machine + Celery + Redis publish birlikte doğrulandı.
* WebSocket tarafında gerçek mesaj akışı gözlemlendi.

---

## 3. Celery Güvenlik ve Tutarlılık Kararları

### acks_late = True

Worker crash durumunda:

* Mesaj broker’a geri düşer.
* Veri kaybı riski azaltılır.

### reject_on_worker_lost = True

Worker ölürse mesaj kaybolmaz.

### Recovery Task

Dakikada bir çalışan task:

* PROCESSING’de uzun süre kalanları tespit eder.
* State’i tekrar QUEUED yapar.
* Stuck işleri yeniden işlenebilir hale getirir.

Bu iki katmanlı koruma sağlar:

Broker seviyesi garanti + DB seviyesi recovery.

---

## 4. Idempotency (DB Tabanlı Koruma)

Duplicate execution riskine karşı:

* ProcessedEventLog modeli eklendi.
* event için unique constraint tanımlandı.
* IntegrityError yakalanarak duplicate veri engellendi.

Bu sayede:

* Task yeniden çalışsa bile duplicate işlenmez.
* Veri bütünlüğü DB seviyesinde korunur.

Bu karar bilinçlidir:

Redis cache tabanlı idempotency yerine DB tabanlı idempotency tercih edildi.
Daha yavaş ama daha güvenli.

---

## 5. Worker Ayrıştırması

Queue’lar ayrıldı:

* processing worker
* maintenance worker (recovery)

Amaç:

* Crash durumunda scheduled taskların da ölmemesi
* Workflow taskları ile bakım tasklarını izole etmek

---

## 6. WebSocket Gateway Gerçek Akış

FastAPI WebSocket gateway tarafında:

* Redis session TTL mekanizması doğrulandı.
* Resume mekanizması çalıştı.
* Redis pub/sub üzerinden event.update mesajları client’a ulaştı.
* wscat ile gerçek canlı mesaj alındı.

Akış doğrulandı:

Django → Celery → Redis publish → WS gateway → Client

Bu artık gerçek event-driven sistemi taklit edebiliyor.

---

## 7. CI Stabilizasyonu

GitHub Actions tarafında kritik düzeltmeler yapıldı:

* PostgreSQL service hostname problemi çözüldü.
* localhost vs service name farkı anlaşıldı.
* Environment değerlerinin nasıl verilmesi gerektiği anlaşıldı. (Her step'in kendi içinde belirtilmeli)
* Test settings ayrı tanımlandı.
* Celery eager test ayarları doğrulandı.
* Migration retry mekanizması eklendi.

CI artık yeşil.

---

## 8. Kritik Öğrenilenler

1. Test ortamı production değildir.
2. transaction.on_commit test runner ile farklı davranır.
3. Celery eager gerçek async davranış değildir. CELERY_TASK_ALWAYS_EAGER true ise task sync çalışır.
4. Idempotency business-level güvenliktir.
5. Broker güvenliği tek başına yeterli değildir.
6. State recovery mekanizması şarttır.
7. Bağımlılık mock’lanabilir ama integration testi daha öğreticidir. (Redis veya benzeri bir toola bağımlılık varsa ayakta olmalı.)
8. Infrastructure kararları koddan ayrı düşünülemez.

---

## 9. Sistem Şu Anda Ne Sağlıyor?

* Crash dayanıklı queue işleme
* Worker ölse veri kaybı olmaması
* Stuck job recovery
* Duplicate veri engelleme
* WebSocket canlı bildirim
* CI ile doğrulanmış lifecycle
* Test ile doğrulanmış state machine

---

## 10. Teknik Borç / Açık Konular

* Redis down olursa publish davranışı netleştirilmeli.
* WebSocket broadcast yerine targeted routing yapılmalı.
* Observability structured log standardı genişletilmeli.
* OpenTelemetry eklenebilir.
* Retry backoff stratejisi eklenebilir.
* Dead letter queue stratejisi düşünülebilir.

